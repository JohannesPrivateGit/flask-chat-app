<!DOCTYPE html>

<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet" type="text/css">

        <link href="/static/style.css" rel="stylesheet">

        <title>Flask Chat App</title>
    </head>

    <body>
        <h1>Group: {{ room }}</h1>

        <div>Group members</div>

        <div id="all_users">
            {% for i in user_list %}
            <div>{{ i }}</div>
            {% endfor %}    
        </div>

        <div>Group member profile pictures</div>

        <div id="all_users_profiles">
            {% for i in user_list %}
            <div>
                <img class="profile_picture" src="/static/profile.png" alt="">
            </div>
            {% endfor %}
        </div>

        <div id="messages"></div>

        <form id="message_input_form">
            <label>
                <input type="text" id="message_input" placeholder="Enter message here">
            </label>
        </form>
    </body>

    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>

    <script>
        // Socket connection.
        const socket = io.connect("http://127.0.0.1:5000");

        // Socket connection code.
        socket.on('connect', function() {
            // When new user is connected, create a join_room message.
            socket.emit('join_room', {
                username: "{{ username }}",
                room: "{{ room }}"
            })

            // Handles user typing in a message in the html Ã­nput field.
            let message_input = document.getElementById('message_input');
            
            // Handles what happens when user submits message.
            document.getElementById('message_input_form').onsubmit = function (e) {
                e.preventDefault();
                let message = message_input.value.trim();
                if (message.length) {
                    socket.emit('send_message', {
                        username: "{{ username }}",
                        room: "{{ room }}",
                        message: message
                    })
                }
                message_input.value = '';
                message_input.focus();
            }

        })

        // Creates a new message if one is recieved.
        socket.on('receive_message', function (data) {
            console.log(data);

            // Creates a div for name and for message.
            const username_div = document.createElement('div')
            const message_div = document.createElement('div')

            // Defines inner HTML code of the divs.
            username_div.innerHTML = `<b>${data.username}</b>`;
            message_div.innerHTML = `${data.message}`;
            
            // Appends them to the message div in the HTML document.
            document.getElementById('messages').appendChild(username_div);
            document.getElementById('messages').appendChild(message_div);
        })

        // Creates a join announcement.
        socket.on('join_room_announcement', function(data) {
            // Logs the incomming data in the console.
            console.log(data);

            // Creates a new element for a div tag in the html document.
            const announcement = document.createElement('div')

            // Displays all usernames on chat page.
            const new_user_name = document.createElement('div')

            // Displays a profile picture for every user.
            const new_user_profile = document.createElement('div')
            
            // Defines html code for element.
            announcement.innerHTML = `<b>${data.username}</b> has joined the room`
            new_user_name.innerHTML = `${data.username}`
            new_user_profile.innerHTML = `<img class="profile_picture" src="/static/profile.png" alt="">`
            
            // Appends new element to the div tag with the all_users ID.
            document.getElementById('messages').appendChild(announcement);
            document.getElementById('all_users').appendChild(new_user_name);
            document.getElementById('all_users_profiles').appendChild(new_user_profile);
        })
    </script>
</html>