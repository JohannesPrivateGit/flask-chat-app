<!DOCTYPE html>

<html>
    <head>
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,300" rel="stylesheet" type="text/css">

        <link href="/static/style.css" rel="stylesheet">

        <title>Flask Chat App</title>
    </head>

    <body>
        <div class="widget">
            <div class="group_title">
                <div><b>Group Members</b></div>
            </div>

            <div class="member_list" id="member_list">
                {% for i in user_list %}
                <div>
                    <div class="member">
                        {% if i.lower() == "admin" %}
                        <img class="member_picture" src="/static/admin.png" alt="">

                        {% elif i.lower() == "küken" %}
                        <img class="member_picture" src="/static/kueken.png" alt="">
                        {% elif i.lower() == "einhorn" %}
                        <img class="member_picture" src="/static/einhorn.png" alt="">
                        {% elif i.lower() == "faultier" %}
                        <img class="member_picture" src="/static/faultier.png" alt="">
                        {% elif i.lower() == "känguru" %}
                        <img class="member_picture" src="/static/kaenguru.png" alt="">
                        {% elif i.lower() == "krokodil" %}
                        <img class="member_picture" src="/static/krokodil.png" alt="">
                        {% elif i.lower() == "schaf" %}
                        <img class="member_picture" src="/static/schaf.png" alt="">
                        {% elif i.lower() == "wiesel" %}
                        <img class="member_picture" src="/static/wiesel.png" alt="">
                        {% elif i.lower() == "zebra" %}
                        <img class="member_picture" src="/static/zebra.png" alt="">
                        
                        {% else %}
                        <img class="member_picture" src="/static/profile.png" alt="">
                        {% endif %}

                        <div class="member_name">
                            <div>{{ i }}</div>
                        </div>
                    </div>
                </div>
                {% endfor%}
            </div>

            {% if role == "admin" %}
            <div class="role_description" id="role_description">
                <div>
                    <b>Admin</b>
                </div>
                <div>This is the Admin. The Admin controls everything.</div>
            </div>
            {% endif %}

            {% if role == "küken" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Küken</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Schau zu und lies aufmerksam den Chat!</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "faultier" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Faultier</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Schule ist leicht.</li>
                    <li>Du liebst Computerspiele.</li>
                    <li>Du bist gerne mal faul.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "schaf" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Schaf</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Du bist eher gemütlich.</li>
                    <li>Du bist Klassensprecher*in.</li>
                    <li>Du liebst es mit anderen zusammen zu sein.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "wiesel" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Wiesel</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Du bist clever.</li>
                    <li>Du bist immer in Bewegung.</li>
                    <li>Du magst Computerspiele.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "einhorn" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Einhorn</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Du liebst tanzen, Partys und flirten.</li>
                    <li>Du machst viel für die Schule.</li>
                    <li>Du bist immer für andere da.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "krokodil" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Krokodil</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Essen ist ganz wichtig für dich.</li>
                    <li>Du bist sehr geduldig.</li>
                    <li>Du bist ein guter Beobachter.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "känguru" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Känguru</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Du bist sportlich.</li>
                    <li>Schule ist nicht dein Ding.</li>
                    <li>Du bist sehr selbstbewusst.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "zebra" %}
            <div class="role_description" id="role_description">
                <div>Du schlüpfst in eine Rolle! Du bist jetzt das <b>Zebra</b> und unterhältst dich mit Freunden aus deiner Klasse im Chat. Ihr redet über den Wandertag oder Ausflug morgen.</div>
                <div>Wichtig für deine Rolle:</div>
                <ul>
                    <li>Du bist neugierig.</li>
                    <li>Du bist viel unterwegs.</li>
                    <li>Du bist leicht zu begeistern.</li>
                </ul>
                <div>Küken ist neu und sucht Anschluss bei euch. <u>Unterhalte dich auch mit Küken!</u></div>
            </div>
            {% endif %}

            {% if role == "spectator" %}
            <button class="clear_button" onclick="clear_chat()">Clear</button>
            {% endif %}
        </div>

        <div class="messages" id="messages">
        </div>

        <form class="input_for_message" id="message_input_form">
            <label>
                <input class="message_input" type="text" id="message_input" placeholder="Enter message here...">
            </label>
        </form>
    </body>

    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>

    <script>
        // Socket connection.
        const socket = io.connect("http://127.0.0.1:5000");

        let own_name = ""

        // The amount of messages is later used for scrolling.
        let message_counter = 0;
        let scroll_counter = 0;

        // Socket connection code.
        socket.on('connect', function() {
            // When new user is connected, create a join_room message.
            socket.emit('join_room', {
                username: "{{ username }}",
                room: "{{ room }}"
            })

            // Set global username to this.
            own_name = "{{ username }}"

            // Handles user typing in a message in the html ínput field.
            let message_input = document.getElementById('message_input');
            
            // Handles what happens when user submits message.
            document.getElementById('message_input_form').onsubmit = function (e) {
                e.preventDefault();
                let message = message_input.value.trim();
                if (message.length) {
                    socket.emit('send_message', {
                        username: "{{ username }}",
                        room: "{{ room }}",
                        message: message
                    })
                }
                message_input.value = '';
                message_input.focus();
            }
        })

        // Creates a new message if one is recieved.
        socket.on('receive_message', function(data) {
            console.log(data);

            if (data.username != 'spectator') {
                // Creates a div for name and for message.
                const message_div = document.createElement('div')

                if (data.username == own_name) {
                    message_div.innerHTML = `<div class="own_message"><div><b>${data.username}</b></div><div>${data.message}</div></div>`;
                } else {
                    message_div.innerHTML = `<div class="other_message"><div><b>${data.username}</b></div><div>${data.message}</div></div>`;
                }

                // Appends them to the message div in the HTML document.
                document.getElementById('messages').appendChild(message_div);

                message_counter = message_counter + 1;
            }
        })

        // Creates a join announcement.
        socket.on('join_room_announcement', function(data) {
            // Logs the incomming data in the console.
            console.log(data);

            // Only do join announcement when person is not a spectator.
            if (data.username == "spectator") {
                // Do nothing
            } else {
                // Creates divs to add to html page.
                const announcement = document.createElement('div')
                const new_user = document.createElement('div')
                
                // Defines html code for element.
                announcement.innerHTML = `<div class="join_announcement"><b>${data.username}</b> has joined the room</div>`
                
                // Determines profile picture based on the username.
                if (data.username.toLowerCase() == "admin") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/admin.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                } else {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/profile.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }

                // Add role profile pictures
                if (data.username.toLowerCase() == "küken") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/kueken.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "einhorn") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/einhorn.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "faultier") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/faultier.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "känguru") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/kaenguru.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "krokodil") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/krokodil.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "schaf") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/schaf.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "wiesel") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/wiesel.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                if (data.username.toLowerCase() == "zebra") {
                    new_user.innerHTML = `<div class="member"><img class="member_picture" src="/static/zebra.png" alt=""><div class="member_name"><div>${data.username}</div></div></div>`
                }
                
                // Appends new element to the div tag with the all_users ID.
                document.getElementById('messages').appendChild(announcement);
                document.getElementById('member_list').appendChild(new_user);
            }

            // Update the message counter.
            message_counter = message_counter + 1;
        })

        // Clears the chat and all members in the member list
        function clear_chat() {
            var msg = document.getElementById('messages');
            while(msg.firstChild){
                msg.removeChild(msg.firstChild);
            }

            var mem = document.getElementById('member_list');
            while(mem.firstChild){
                mem.removeChild(mem.firstChild);
            }
        }

        // Scrolls down the message div automatically when new content builds up.
        function check_for_scrolling() {
            setTimeout(function() {
                if (message_counter != scroll_counter) {
                    var msg_div = document.getElementById("messages");
                    msg_div.scrollTop = msg_div.scrollHeight;
                    scroll_counter = scroll_counter + 1;
                }
                check_for_scrolling();
            }, 1)
        }

        check_for_scrolling();
    </script>
</html>